name: Slack Webhook Test

on:
  push:
    branches: [ "main" ]

jobs:
  MsgTest:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Store Certification
        run: openssl s_client -showcerts -connect gk-api.samsung.com:443 > chain.pem

      - name: Cert Store
        run: |
          gawk 'BEGIN { pipe="openssl x509 -noout -subject -dates "} /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe } ' chain.pem | grep subject | awk -F = '{print $7}' > result.txt          
          gawk 'BEGIN { pipe="openssl x509 -noout -subject -dates "} /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe } ' chain.pem | grep notAfter | awk -F = '{print $2}' >> result.txt
          
          gawk 'BEGIN { pipe="openssl x509 -noout -subject -dates "} /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe } /^-+END CERT/ { close(pipe); printf("\n")}  ' chain.pem | grep subject | awk -F = '{print $6}' | sed -n 2p > result2.txt
          gawk 'BEGIN { pipe="openssl x509 -noout -subject -dates "} /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe } /^-+END CERT/ { close(pipe); printf("\n")}  ' chain.pem | grep notAfter | awk -F = '{print $2}' | sed -n 2p >> result2.txt
          
          gawk 'BEGIN { pipe="openssl x509 -noout -subject -dates "} /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe } /^-+END CERT/ { close(pipe); printf("\n")}  ' chain.pem | grep subject | awk -F = '{print $6}' | sed -n 3p > result3.txt
          gawk 'BEGIN { pipe="openssl x509 -noout -subject -dates "} /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe } /^-+END CERT/ { close(pipe); printf("\n")}  ' chain.pem | grep notAfter | awk -F = '{print $2}' | sed -n 3p >> result3.txt


      - name: Certificate Verification
        uses: mathiasvr/command-output@v1
        id: console
        with:
          run: |
            COLR=pwf
            echo ""
            echo $COLR
            echo ""
            
            if [ "$COLR" == "ppp" ]; then            
              echo "COLORS=$(echo good)" >> $GITHUB_ENV
            else
              if [ "${COLR:0:1}" == "f" -o "${COLR:1:1}" == "f" -o "${COLR:2:1}" == "f" ]; then              
                echo "COLORS=$(echo \#ff3333)" >> $GITHUB_ENV
              else              
                echo "COLORS=$(echo \#e6e600)" >> $GITHUB_ENV
              fi
            fi

      - name: slack send
        uses: rtCamp/action-slack-notify@master
        env:
          SLACK_TITLE: Sender
          MSG_MINIMAL: true
          SLACK_COLOR: ${{ env.COLORS }}
          SLACK_MESSAGE: ${{ steps.console.outputs.stdout }}
          SLACK_WEBHOOK: ${{ secrets.CERT_WEBHOOK_URL }}
